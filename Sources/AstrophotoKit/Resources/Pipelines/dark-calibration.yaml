id: dark_calibration
name: Dark Frame Calibration Pipeline
description: |
  Calibrates dark frames by first creating a master bias from a set of bias frames,
  then subtracting the master bias from each dark frame, and finally stacking
  the calibrated dark frames into a master dark.

steps:
  # Step 1: Stack bias frames into master bias
  - id: stack_bias
    type: stack_frames
    name: Stack Bias Frames
    description: Stacks multiple bias frames into a master bias frame using median or mean stacking
    dataInputs:
      - name: input_frames
        from: bias_frames
        is_collection: true
        collection_mode: together
        metadata_restrictions:
          frame_type:
            - bias
        description: Collection of bias frames to stack
    parameters:
      - name: method
        from: stacking_method
        default_value: "median"
        description: Stacking method (median, mean, or sigma_clip)
      - name: rejection_threshold
        from: rejection_threshold
        default_value: 3.0
        description: Sigma rejection threshold for sigma_clip method
    outputs:
      - name: master_bias
        description: Master bias frame created by stacking input bias frames
        metadata:
          processing_stage: "calibration"
          frame_type: "master_bias"
          stacking_method: "median"
          image_type: "grayscale"

  # Step 2: Subtract master bias from each dark frame
  # This step will process each dark frame individually
  - id: subtract_bias_from_dark
    type: subtract_frames
    name: Subtract Master Bias from Dark Frames
    description: Subtracts the master bias from each dark frame to remove bias signal
    dataInputs:
      - name: input_frame
        from: dark_frames
        is_collection: true
        collection_mode: individually
        metadata_restrictions:
          frame_type:
            - dark
        description: Individual dark frame to calibrate (each frame processed separately)
      - name: subtract_frame
        from: stack_bias.master_bias
        metadata_restrictions:
          frame_type:
            - master_bias
        description: Master bias frame to subtract
    parameters:
      - name: preserve_negative
        from: preserve_negative
        default_value: false
        description: Whether to preserve negative values after subtraction
    outputs:
      - name: calibrated_dark
        description: Dark frame with bias signal removed
        metadata:
          processing_stage: "calibration"
          frame_type: "calibrated_dark"
          calibration_applied:
            - "bias_subtraction"
          image_type: "grayscale"

  # Step 3: Stack calibrated dark frames into master dark
  - id: stack_dark
    type: stack_frames
    name: Stack Calibrated Dark Frames
    description: Stacks the bias-corrected dark frames into a master dark frame
    dataInputs:
      - name: input_frames
        from: subtract_bias_from_dark.calibrated_dark
        is_collection: true
        collection_mode: together
        metadata_restrictions:
          frame_type:
            - calibrated_dark
        description: Collection of bias-corrected dark frames to stack
    parameters:
      - name: method
        from: dark_stacking_method
        default_value: "median"
        description: Stacking method for dark frames (median, mean, or sigma_clip)
      - name: rejection_threshold
        from: dark_rejection_threshold
        default_value: 3.0
        description: Sigma rejection threshold for sigma_clip method
    outputs:
      - name: master_dark
        description: Master dark frame created by stacking calibrated dark frames
        metadata:
          processing_stage: "calibration"
          frame_type: "master_dark"
          stacking_method: "median"
          calibration_applied:
            - "bias_subtraction"
          image_type: "grayscale"

